<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>MrB – Futures Flow</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MrB">

  <!-- Icons (cache-busted) -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png?v=4">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png?v=4">

  <!-- Manifest -->
  <link rel="manifest" href="./manifest.webmanifest?v=4">

  <!-- Basic styling -->
  <style>
    :root {
      --bg: #0b0e14;
      --card: #121826;
      --text: #e6e8eb;
      --muted: #9aa0a6;
      --ok: #2ecc71;
      --warn: #f1c40f;
      --bad: #e74c3c;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 { font-size: 18px; margin: 0 0 6px; }

    .muted { color: var(--muted); font-size: 13px; }

    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
    }

    .group-title {
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .choices {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    label {
      border: 1px solid #2a3142;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }

    input { margin-right: 6px; }

    .result h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .ok { border-left: 4px solid var(--ok); }
    .warn { border-left: 4px solid var(--warn); }
    .bad { border-left: 4px solid var(--bad); }

    button {
      background: #1c2333;
      border: 1px solid #2a3142;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
    }

    .btns {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .debug {
      font-size: 12px;
      margin-top: 8px;
      color: var(--muted);
    }

    /* Checklist styles */
    .checklist {
      display: grid;
      gap: 8px;
    }
    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      border: 1px solid #2a3142;
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
    }
    .check-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      flex: 0 0 auto;
    }
    .check-text {
      line-height: 1.25;
      font-size: 14px;
    }
    .done .check-text {
      color: var(--muted);
      text-decoration: line-through;
    }
    .pill {
      font-size: 12px;
      color: var(--muted);
      border: 1px solid #2a3142;
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>MrB – Futures Flow</h1>
    <div class="muted">Price · CVD · Open Interest</div>

    <!-- ✅ Daily Checklist -->
    <div class="card" id="dailyCard">
      <div class="group-title">
        <div>Daily Checklist</div>
        <div class="pill" id="dailyMeta">0/0</div>
      </div>
      <div class="muted" id="dailyDate"></div>

      <div class="checklist" id="checklist"></div>

      <div class="btns">
        <button id="dailyReset">Reset today</button>
        <button id="dailyAllDone">Mark all done</button>
        <button id="dailyCopy">Copy checklist</button>
      </div>
    </div>

    <!-- Existing flow inputs -->
    <div class="card">
      <div class="group-title">Price</div>
      <div class="choices" id="price"></div>
    </div>

    <div class="card">
      <div class="group-title">CVD</div>
      <div class="choices" id="cvd"></div>
    </div>

    <div class="card">
      <div class="group-title">Open Interest</div>
      <div class="choices" id="oi"></div>
    </div>

    <div class="card result" id="result">
      <h2 id="state">Select inputs…</h2>
      <p id="interpretation" class="muted"></p>
      <p><strong>Play:</strong> <span id="play"></span></p>
      <p><strong>Risk:</strong> <span id="risk"></span></p>

      <div class="debug" id="debug"></div>

      <div class="btns">
        <button id="reset">Reset</button>
        <button id="copy">Copy</button>
      </div>
    </div>
  </div>

<script>
  // -------------------------
  // Daily checklist
  // -------------------------
  const TZ = "Europe/Amsterdam";

  const DAILY_RULES = [
    "Only open long below VWAP",
    "Only open short above VWAP",
    "Don’t make your stop loss wider after defining your invalidation",
    "Check your bands (Above, below, wide, thin)",
    "Only buy on bar close",
    "Don’t rush",
    "Only on confirmation / cross over",
    "10x — don’t break rule",
    "Be very sure when adding to a trade (increases risk)",
    "Take your profit and leave (don’t wait)",
    "Any profit is good profit",
    "Mark out your levels (where you want to do business)",
    "After you take profit (don’t jump back in)"
  ];

  function ymdInTimeZone(date = new Date(), timeZone = TZ) {
    // stable YYYY-MM-DD in a specific timezone
    const parts = new Intl.DateTimeFormat("en-CA", {
      timeZone,
      year: "numeric",
      month: "2-digit",
      day: "2-digit"
    }).formatToParts(date);
    const get = (t) => parts.find(p => p.type === t)?.value;
    return `${get("year")}-${get("month")}-${get("day")}`;
  }

  function prettyDateInTZ(date = new Date(), timeZone = TZ) {
    return new Intl.DateTimeFormat("en-GB", {
      timeZone,
      weekday: "short",
      year: "numeric",
      month: "short",
      day: "2-digit"
    }).format(date);
  }

  function checklistStorageKey() {
    return `mrb_daily_checklist_${ymdInTimeZone()}`;
  }

  function loadChecklistState() {
    try {
      const raw = localStorage.getItem(checklistStorageKey());
      if (!raw) return Array(DAILY_RULES.length).fill(false);
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed) || parsed.length !== DAILY_RULES.length) {
        return Array(DAILY_RULES.length).fill(false);
      }
      return parsed.map(Boolean);
    } catch {
      return Array(DAILY_RULES.length).fill(false);
    }
  }

  function saveChecklistState(stateArr) {
    localStorage.setItem(checklistStorageKey(), JSON.stringify(stateArr));
  }

  function updateChecklistMeta(stateArr) {
    const done = stateArr.filter(Boolean).length;
    document.getElementById("dailyMeta").textContent = `${done}/${stateArr.length} complete`;
  }

  function renderChecklist() {
    // Show "today" in Amsterdam time
    document.getElementById("dailyDate").textContent = `Today: ${prettyDateInTZ()} (${TZ})`;

    const container = document.getElementById("checklist");
    container.innerHTML = "";

    const stateArr = loadChecklistState();

    DAILY_RULES.forEach((text, idx) => {
      const row = document.createElement("label");
      row.className = "check-item";
      row.setAttribute("data-idx", String(idx));

      const box = document.createElement("input");
      box.type = "checkbox";
      box.checked = !!stateArr[idx];

      const span = document.createElement("div");
      span.className = "check-text";
      span.textContent = `${idx + 1}. ${text}`;

      row.appendChild(box);
      row.appendChild(span);

      if (box.checked) row.classList.add("done");

      box.addEventListener("change", () => {
        const s = loadChecklistState();
        s[idx] = box.checked;
        saveChecklistState(s);
        row.classList.toggle("done", box.checked);
        updateChecklistMeta(s);
      });

      container.appendChild(row);
    });

    updateChecklistMeta(stateArr);
  }

  function resetChecklistToday() {
    const blank = Array(DAILY_RULES.length).fill(false);
    saveChecklistState(blank);
    renderChecklist();
  }

  function markAllDone() {
    const all = Array(DAILY_RULES.length).fill(true);
    saveChecklistState(all);
    renderChecklist();
  }

  function buildChecklistCopy() {
    const s = loadChecklistState();
    const date = prettyDateInTZ();
    const lines = DAILY_RULES.map((r, i) => `${s[i] ? "✅" : "☐"} ${i + 1}. ${r}`);
    return [`MrB Daily Checklist — ${date} (${TZ})`, ...lines].join("\n");
  }

  // Optional: re-render if day changes while app is open
  let lastDayKey = checklistStorageKey();
  setInterval(() => {
    const nowKey = checklistStorageKey();
    if (nowKey !== lastDayKey) {
      lastDayKey = nowKey;
      renderChecklist();
    }
  }, 30_000);

  // -------------------------
  // Existing flow rules UI
  // -------------------------
  const OPTIONS = [
    { key: "up", label: "↑ Up" },
    { key: "down", label: "↓ Down" },
    { key: "flat", label: "→ Flat" }
  ];

  const selection = { price: null, cvd: null, open_interest: null };
  let rules = null;

  function renderGroup(id, key) {
    const el = document.getElementById(id);
    OPTIONS.forEach(opt => {
      const label = document.createElement("label");
      const input = document.createElement("input");

      input.type = "radio";
      input.name = key;
      input.value = opt.key;
      input.addEventListener("input", () => {
        selection[key] = opt.key;
        update();
      });

      label.appendChild(input);
      label.append(opt.label);
      el.appendChild(label);
    });
  }

  function classify(id) {
    if (!id) return "";
    if (id.includes("trend")) return "ok";
    if (id.includes("trap")) return "bad";
    return "warn";
  }

  function update() {
    document.getElementById("debug").textContent =
      `price=${selection.price || "?"}, cvd=${selection.cvd || "?"}, oi=${selection.open_interest || "?"}`;

    if (!selection.price || !selection.cvd || !selection.open_interest) return;

    const state = rules?.states?.find(s =>
      s.condition.price === selection.price &&
      s.condition.cvd === selection.cvd &&
      s.condition.open_interest === selection.open_interest
    );

    const card = document.getElementById("result");
    card.className = "card result";

    if (!state) {
      document.getElementById("state").textContent = "No rule defined";
      document.getElementById("interpretation").textContent = "";
      document.getElementById("play").textContent = "";
      document.getElementById("risk").textContent = "";
      return;
    }

    card.classList.add(classify(state.id));
    document.getElementById("state").textContent = state.market_state;
    document.getElementById("interpretation").textContent = state.interpretation;
    document.getElementById("play").textContent = state.play;
    document.getElementById("risk").textContent = state.risk_note;
  }

  async function init() {
    // ✅ Checklist
    renderChecklist();
    document.getElementById("dailyReset").onclick = resetChecklistToday;
    document.getElementById("dailyAllDone").onclick = markAllDone;
    document.getElementById("dailyCopy").onclick = async () => {
      const text = buildChecklistCopy();
      await navigator.clipboard.writeText(text);
      alert("Checklist copied");
    };

    // ✅ Existing flow UI
    renderGroup("price", "price");
    renderGroup("cvd", "cvd");
    renderGroup("oi", "open_interest");

    const res = await fetch("./rules.json?v=4");
    rules = await res.json();

    document.getElementById("reset").onclick = () => location.reload();
    document.getElementById("copy").onclick = async () => {
      const text = document.getElementById("state").textContent;
      if (text) await navigator.clipboard.writeText(text);
      alert("Copied");
    };
  }

  init();
</script>
</body>
</html>
