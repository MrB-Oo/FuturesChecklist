<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Futures Flow Checklist</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 16px; max-width: 720px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { display: grid; gap: 10px; margin-bottom: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    .group-title { font-weight: 700; margin-bottom: 6px; }
    .choices { display: flex; gap: 10px; flex-wrap: wrap; }
    label { border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; cursor: pointer; user-select: none; }
    input { margin-right: 6px; }
    .result h2 { margin: 0 0 8px; font-size: 16px; }
    .muted { color: #666; }
    .pill { display: inline-block; padding: 3px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; margin-left: 6px; }
    .warn { border-color: #f2c200; }
    .ok { border-color: #4caf50; }
    .bad { border-color: #f44336; }
    .btns { display: flex; gap: 10px; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Futures Flow Checklist <span class="pill" id="ver">v?</span></h1>
  <p class="muted">Pick directions. Result updates instantly.</p>

  <div class="row">
    <div class="card">
      <div class="group-title">Price</div>
      <div class="choices" id="price"></div>
    </div>

    <div class="card">
      <div class="group-title">CVD</div>
      <div class="choices" id="cvd"></div>
    </div>

    <div class="card">
      <div class="group-title">Open Interest</div>
      <div class="choices" id="oi"></div>
    </div>

    <div class="card result" id="resultCard">
      <h2 id="stateTitle">Select inputs…</h2>
      <p id="interpretation" class="muted"></p>
      <p><strong>Play:</strong> <span id="play"></span></p>
      <p><strong>Risk:</strong> <span id="risk"></span></p>

      <div class="btns">
        <button id="reset">Reset</button>
        <button id="copy">Copy result</button>
      </div>
    </div>
  </div>

<script>
  const OPTIONS = [
    { key: "up",   label: "↑ Up" },
    { key: "down", label: "↓ Down" },
    { key: "flat", label: "→ Flat" }
  ];

  let rules = null;
  const selection = { price: null, cvd: null, open_interest: null };

  function renderGroup(containerId, field) {
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    OPTIONS.forEach(opt => {
      const id = `${field}_${opt.key}`;
      const label = document.createElement("label");
      label.htmlFor = id;

      const input = document.createElement("input");
      input.type = "radio";
      input.name = field;
      input.id = id;
      input.value = opt.key;

      input.addEventListener("change", () => {
        selection[field] = opt.key;
        updateResult();
      });

      label.appendChild(input);
      label.appendChild(document.createTextNode(opt.label));
      el.appendChild(label);
    });
  }

  function matchState() {
    if (!rules) return null;
    const { price, cvd, open_interest } = selection;
    if (!price || !cvd || !open_interest) return null;

    return rules.states.find(s =>
      s.condition.price === price &&
      s.condition.cvd === cvd &&
      s.condition.open_interest === open_interest
    ) || null;
  }

  function setCardClass(card, kind) {
    card.classList.remove("ok", "warn", "bad");
    if (kind) card.classList.add(kind);
  }

  function classify(stateId) {
    // Simple visual cue: trends=ok, traps/liquidations=warn, chop=warn
    if (!stateId) return null;
    if (stateId.includes("initiative")) return "ok";
    if (stateId.includes("trap")) return "bad";
    if (stateId.includes("liquidation") || stateId.includes("squeeze") || stateId.includes("rotation") || stateId.includes("chop")) return "warn";
    return null;
  }

  function updateResult() {
    const card = document.getElementById("resultCard");
    const state = matchState();

    if (!state) {
      document.getElementById("stateTitle").textContent = "Select inputs…";
      document.getElementById("interpretation").textContent = "";
      document.getElementById("play").textContent = "";
      document.getElementById("risk").textContent = "";
      setCardClass(card, null);
      return;
    }

    document.getElementById("stateTitle").textContent = state.market_state;
    document.getElementById("interpretation").textContent = state.interpretation;
    document.getElementById("play").textContent = state.play;
    document.getElementById("risk").textContent = state.risk_note;

    setCardClass(card, classify(state.id));
  }

  async function init() {
    renderGroup("price", "price");
    renderGroup("cvd", "cvd");
    renderGroup("oi", "open_interest");

    const res = await fetch("./rules.json", { cache: "no-store" });
    rules = await res.json();
    document.getElementById("ver").textContent = "v" + (rules.version || "?");

    document.getElementById("reset").addEventListener("click", () => {
      ["price","cvd","open_interest"].forEach(name => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(i => i.checked = false);
      });
      selection.price = selection.cvd = selection.open_interest = null;
      updateResult();
    });

    document.getElementById("copy").addEventListener("click", async () => {
      const state = matchState();
      if (!state) return;

      const text =
`Market state: ${state.market_state}
Interpretation: ${state.interpretation}
Play: ${state.play}
Risk: ${state.risk_note}`;

      try {
        await navigator.clipboard.writeText(text);
        alert("Copied!");
      } catch {
        alert("Copy failed (iOS may require HTTPS / user gesture).");
      }
    });

    updateResult();
  }

  init();
</script>
</body>
</html>